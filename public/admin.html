<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Donna Admin</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { font-size: 24px; margin-bottom: 4px; }
    header p { opacity: 0.9; font-size: 13px; }
    /* Version badge in header */
    .version-badge {
      background: rgba(255,255,255,0.15);
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      color: rgba(255,255,255,0.9);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }
    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      font-size: 15px;
      font-weight: 500;
      color: #666;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }
    .tab:hover { color: #667eea; }
    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Cards */
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .card h2 {
      font-size: 16px;
      margin-bottom: 16px;
      color: #444;
      border-bottom: 2px solid #667eea;
      padding-bottom: 8px;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #667eea;
    }
    .stat-label {
      font-size: 13px;
      color: #888;
      margin-top: 4px;
    }

    /* Forms */
    .form-group { margin-bottom: 14px; }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 13px;
      color: #555;
    }
    input, textarea, select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }
    textarea { resize: vertical; min-height: 70px; }
    .hint { font-size: 11px; color: #888; margin-top: 2px; }

    /* Buttons */
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    button.secondary { background: #e0e0e0; color: #333; }
    button.secondary:hover { background: #d0d0d0; box-shadow: none; }
    button.danger { background: #e74c3c; }
    button.small { padding: 6px 12px; font-size: 12px; }

    /* Lists */
    .list-item {
      background: #fafafa;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .list-item h3 { font-size: 15px; margin-bottom: 2px; }
    .list-item p { font-size: 13px; color: #666; margin-bottom: 2px; }
    .list-item .meta { font-size: 12px; color: #888; }
    .list-item .actions { display: flex; gap: 6px; flex-shrink: 0; }
    .list-item .actions button { padding: 6px 10px; font-size: 12px; }

    .tag {
      display: inline-block;
      background: #e8e8ff;
      color: #667eea;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      margin-right: 4px;
    }
    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }
    .status-badge.completed { background: #d4edda; color: #155724; }
    .status-badge.failed, .status-badge.no-answer { background: #f8d7da; color: #721c24; }
    .status-badge.in-progress { background: #fff3cd; color: #856404; }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #888;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: white;
      border-radius: 12px;
      padding: 24px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal h2 { margin-bottom: 16px; font-size: 18px; }
    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    /* Transcript */
    .transcript { max-height: 400px; overflow-y: auto; }
    .transcript-message {
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 8px;
    }
    .transcript-message.donna { background: #e8e8ff; }
    .transcript-message.user { background: #f0f0f0; }
    .transcript-message .speaker {
      font-weight: 600;
      font-size: 12px;
      margin-bottom: 4px;
    }

    /* Recurring options */
    .recurring-options {
      display: flex;
      gap: 16px;
      margin-top: 8px;
    }
    .recurring-options label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: normal;
      cursor: pointer;
    }

    /* Memories */
    .memories-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #eee;
    }
    .memory-chip {
      background: #f8f8ff;
      border: 1px solid #e8e8ff;
      border-radius: 6px;
      padding: 8px 10px;
      font-size: 12px;
      margin-bottom: 6px;
    }
    .memory-type {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      margin-right: 6px;
    }
    .senior-memories {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px dashed #ddd;
    }
    .senior-memories .label {
      font-size: 11px;
      color: #888;
      text-transform: uppercase;
      margin-bottom: 6px;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
      z-index: 1000;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background: #27ae60; }
    .toast.error { background: #e74c3c; }
  </style>
</head>
<body>
  <!-- Login Overlay -->
  <div id="loginOverlay" style="position:fixed;inset:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;z-index:200;">
    <div style="background:white;border-radius:16px;padding:40px;width:90%;max-width:400px;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
      <h1 style="text-align:center;margin-bottom:8px;color:#333;">Donna Admin</h1>
      <p style="text-align:center;color:#888;margin-bottom:24px;font-size:14px;">Sign in to manage your seniors</p>
      <form id="loginForm">
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" required placeholder="admin@donna.com">
        </div>
        <div class="form-group">
          <label for="loginPassword">Password</label>
          <input type="password" id="loginPassword" required placeholder="Your password">
        </div>
        <p id="loginError" style="color:#e74c3c;font-size:13px;margin-bottom:12px;display:none;"></p>
        <button type="submit" style="width:100%;">Sign In</button>
      </form>
    </div>
  </div>

  <div class="container">
    <header>
      <div>
        <h1>Donna Admin</h1>
        <p>Manage seniors, calls, and reminders</p>
      </div>
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="version-badge">v3.3</div>
        <button class="small secondary" onclick="logout()" style="background:#ffffff33;color:white;">Logout</button>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="dashboard">Dashboard</button>
      <button class="tab" data-tab="seniors">Seniors</button>
      <button class="tab" data-tab="calls">Calls</button>
      <button class="tab" data-tab="reminders">Reminders</button>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard" class="tab-content active">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="statSeniors">-</div>
          <div class="stat-label">Seniors</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statCallsToday">-</div>
          <div class="stat-label">Calls Today</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statUpcoming">-</div>
          <div class="stat-label">Upcoming</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statActive">-</div>
          <div class="stat-label">Active Calls</div>
        </div>
      </div>

      <div class="card">
        <h2>Recent Calls</h2>
        <div id="recentCallsList"></div>
      </div>

      <div class="card">
        <h2>Upcoming Reminders</h2>
        <div id="upcomingRemindersList"></div>
      </div>
    </div>

    <!-- Seniors Tab -->
    <div id="seniors" class="tab-content">
      <div class="card">
        <h2>Add New Senior</h2>
        <form id="addSeniorForm">
          <div class="form-row">
            <div class="form-group">
              <label for="name">Name *</label>
              <input type="text" id="name" required placeholder="e.g., Margaret Johnson">
            </div>
            <div class="form-group">
              <label for="phone">Phone *</label>
              <input type="tel" id="phone" required placeholder="e.g., +1 555 123 4567">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="location">Location</label>
              <input type="text" id="location" placeholder="e.g., Miami, FL">
            </div>
            <div class="form-group">
              <label for="interests">Interests</label>
              <input type="text" id="interests" placeholder="gardening, baking, puzzles">
              <p class="hint">Comma-separated</p>
            </div>
          </div>
          <div class="form-group">
            <label for="medicalNotes">Medical Notes</label>
            <textarea id="medicalNotes" placeholder="Any health information..."></textarea>
          </div>
          <button type="submit">Add Senior</button>
        </form>
      </div>

      <div class="card">
        <h2>Seniors</h2>
        <div id="seniorsList"></div>
      </div>
    </div>

    <!-- Calls Tab -->
    <div id="calls" class="tab-content">
      <div class="card">
        <h2>Call History</h2>
        <div id="callsList"></div>
      </div>
    </div>

    <!-- Reminders Tab -->
    <div id="reminders" class="tab-content">
      <div class="card">
        <h2>Add New Reminder</h2>
        <form id="addReminderForm">
          <div class="form-row">
            <div class="form-group">
              <label for="reminderSenior">Senior *</label>
              <select id="reminderSenior" required>
                <option value="">Select senior...</option>
              </select>
            </div>
            <div class="form-group">
              <label for="reminderType">Type</label>
              <select id="reminderType">
                <option value="medication">Medication</option>
                <option value="appointment">Appointment</option>
                <option value="custom">Custom</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="reminderTitle">Title *</label>
            <input type="text" id="reminderTitle" required placeholder="e.g., Blood pressure medication">
          </div>
          <div class="form-group">
            <label for="reminderDescription">Description</label>
            <textarea id="reminderDescription" placeholder="Additional details..."></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="reminderDate">Date</label>
              <input type="date" id="reminderDate">
            </div>
            <div class="form-group">
              <label for="reminderTime">Time *</label>
              <input type="time" id="reminderTime" required>
            </div>
          </div>
          <div class="form-group">
            <label>Recurring</label>
            <div class="recurring-options">
              <label><input type="radio" name="recurring" value="once" checked> One-time</label>
              <label><input type="radio" name="recurring" value="daily"> Daily</label>
              <label><input type="radio" name="recurring" value="weekly"> Weekly</label>
            </div>
          </div>
          <button type="submit">Add Reminder</button>
        </form>
      </div>

      <div class="card">
        <h2>Active Reminders</h2>
        <div id="remindersList"></div>
      </div>
    </div>
  </div>

  <!-- Edit Senior Modal -->
  <div class="modal-overlay" id="editSeniorModal">
    <div class="modal">
      <h2>Edit Senior</h2>
      <form id="editSeniorForm">
        <input type="hidden" id="editSeniorId">
        <div class="form-row">
          <div class="form-group">
            <label for="editName">Name *</label>
            <input type="text" id="editName" required>
          </div>
          <div class="form-group">
            <label for="editPhone">Phone *</label>
            <input type="tel" id="editPhone" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="editLocation">Location</label>
            <input type="text" id="editLocation">
          </div>
          <div class="form-group">
            <label for="editInterests">Interests</label>
            <input type="text" id="editInterests">
          </div>
        </div>
        <div class="form-group">
          <label for="editMedicalNotes">Medical Notes</label>
          <textarea id="editMedicalNotes"></textarea>
        </div>

        <div class="memories-section">
          <h3 style="font-size: 14px; margin-bottom: 12px; color: #667eea;">Memories</h3>
          <div style="display: flex; gap: 8px; margin-bottom: 12px;">
            <select id="memoryType" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 13px;">
              <option value="fact">Fact</option>
              <option value="preference">Preference</option>
              <option value="event">Event</option>
              <option value="concern">Concern</option>
              <option value="relationship">Relationship</option>
            </select>
            <input type="text" id="memoryContent" placeholder="e.g., Has a grandson named Tommy" style="flex: 1; font-size: 13px;">
            <button type="button" class="small secondary" onclick="addMemory()">Add</button>
          </div>
          <div id="memoriesList" style="max-height: 200px; overflow-y: auto;"></div>
        </div>

        <div class="modal-actions">
          <button type="button" class="secondary" onclick="closeModal('editSeniorModal')">Cancel</button>
          <button type="submit">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Transcript Modal -->
  <div class="modal-overlay" id="transcriptModal">
    <div class="modal">
      <h2 id="transcriptTitle">Call Transcript</h2>
      <div id="transcriptContent" class="transcript"></div>
      <div class="modal-actions">
        <button class="secondary" onclick="closeModal('transcriptModal')">Close</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    const API = window.location.origin;
    let authToken = localStorage.getItem('donna_admin_token');

    // Authenticated fetch wrapper
    async function authFetch(url, options = {}) {
      const headers = { ...options.headers };
      if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
      }
      if (options.body) {
        headers['Content-Type'] = 'application/json';
      }
      const res = await fetch(url, { ...options, headers });
      if (res.status === 401) {
        authToken = null;
        localStorage.removeItem('donna_admin_token');
        showLogin();
        throw new Error('Unauthorized');
      }
      return res;
    }

    function showLogin() {
      document.getElementById('loginOverlay').style.display = 'flex';
    }

    function hideLogin() {
      document.getElementById('loginOverlay').style.display = 'none';
    }

    function logout() {
      authToken = null;
      localStorage.removeItem('donna_admin_token');
      showLogin();
    }

    // Login form handler
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('loginError');
      errorEl.style.display = 'none';

      try {
        const res = await fetch(`${API}/api/admin/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });
        const data = await res.json();
        if (!res.ok) {
          errorEl.textContent = data.error || 'Login failed';
          errorEl.style.display = 'block';
          return;
        }
        authToken = data.token;
        localStorage.setItem('donna_admin_token', data.token);
        hideLogin();
        loadAll();
      } catch (err) {
        errorEl.textContent = 'Connection error';
        errorEl.style.display = 'block';
      }
    });

    // Check auth on load
    async function checkAuth() {
      if (!authToken) { showLogin(); return; }
      try {
        const res = await fetch(`${API}/api/admin/me`, {
          headers: { 'Authorization': `Bearer ${authToken}` },
        });
        if (!res.ok) { showLogin(); return; }
        hideLogin();
        loadAll();
      } catch {
        showLogin();
      }
    }

    // Toast
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });

    // Modals
    function closeModal(id) {
      document.getElementById(id).classList.remove('show');
    }

    // Escape HTML
    function esc(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Format date
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      const now = new Date();
      const diff = now - d;
      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return `${Math.floor(diff/60000)} min ago`;
      if (diff < 86400000) return `${Math.floor(diff/3600000)} hours ago`;
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
    }

    function formatDuration(seconds) {
      if (!seconds) return '0:00';
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${m}:${s.toString().padStart(2, '0')}`;
    }

    // ============ DASHBOARD ============
    async function loadDashboard() {
      try {
        const res = await authFetch(`${API}/api/stats`);
        const stats = await res.json();

        document.getElementById('statSeniors').textContent = stats.totalSeniors;
        document.getElementById('statCallsToday').textContent = stats.callsToday;
        document.getElementById('statUpcoming').textContent = stats.upcomingRemindersCount;
        document.getElementById('statActive').textContent = stats.activeCalls;

        // Recent calls
        const callsHtml = stats.recentCalls?.length
          ? stats.recentCalls.map(c => `
            <div class="list-item">
              <div>
                <h3>${esc(c.seniorName) || 'Unknown'}</h3>
                <p class="meta">${formatDate(c.startedAt)} &bull; ${formatDuration(c.durationSeconds)}</p>
              </div>
              <span class="status-badge ${c.status || ''}">${c.status || 'unknown'}</span>
            </div>
          `).join('')
          : '<p class="empty-state">No recent calls</p>';
        document.getElementById('recentCallsList').innerHTML = callsHtml;

        // Upcoming reminders
        const remHtml = stats.upcomingReminders?.length
          ? stats.upcomingReminders.map(r => `
            <div class="list-item">
              <div>
                <h3>${esc(r.title)}</h3>
                <p>${esc(r.seniorName)} &bull; ${r.type}</p>
                <p class="meta">${new Date(r.scheduledTime).toLocaleString()}</p>
              </div>
            </div>
          `).join('')
          : '<p class="empty-state">No upcoming reminders</p>';
        document.getElementById('upcomingRemindersList').innerHTML = remHtml;
      } catch (e) {
        console.error('Failed to load dashboard', e);
      }
    }

    // ============ SENIORS ============
    async function loadSeniors() {
      try {
        const res = await authFetch(`${API}/api/seniors`);
        const seniors = await res.json();

        // Fetch memories for each senior
        const seniorsWithMemories = await Promise.all(
          seniors.map(async (senior) => {
            try {
              const memRes = await authFetch(`${API}/api/seniors/${senior.id}/memories`);
              const memories = await memRes.json();
              return { ...senior, memories: memories.slice(0, 5) };
            } catch {
              return { ...senior, memories: [] };
            }
          })
        );

        renderSeniors(seniorsWithMemories);
        populateSeniorDropdown(seniors);
      } catch (e) {
        showToast('Failed to load seniors', 'error');
      }
    }

    function renderSeniors(seniors) {
      if (!seniors.length) {
        document.getElementById('seniorsList').innerHTML = '<p class="empty-state">No seniors yet</p>';
        return;
      }
      document.getElementById('seniorsList').innerHTML = seniors.map(s => `
        <div class="list-item">
          <div style="flex: 1;">
            <h3>${esc(s.name)}</h3>
            <p>${esc(s.phone)}</p>
            ${s.familyInfo?.location ? `<p class="meta">${esc(s.familyInfo.location)}</p>` : ''}
            <div>${(s.interests || []).map(i => `<span class="tag">${esc(i)}</span>`).join('')}</div>
            ${s.memories && s.memories.length > 0 ? `
              <div class="senior-memories">
                <p class="label">Memories</p>
                ${s.memories.map(m => `
                  <div class="memory-chip">
                    <span class="memory-type">${esc(m.type)}</span>
                    ${esc(m.content)}
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
          <div class="actions">
            <button class="small" onclick="callSenior('${s.phone}', '${esc(s.name)}')">Call</button>
            <button class="small secondary" onclick="editSenior('${s.id}')">Edit</button>
            <button class="small danger" onclick="deleteSenior('${s.id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function populateSeniorDropdown(seniors) {
      const sel = document.getElementById('reminderSenior');
      sel.innerHTML = '<option value="">Select senior...</option>' +
        seniors.map(s => `<option value="${s.id}">${esc(s.name)}</option>`).join('');
    }

    document.getElementById('addSeniorForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true;

      const data = {
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value,
        interests: document.getElementById('interests').value.split(',').map(i => i.trim()).filter(i => i),
        familyInfo: { location: document.getElementById('location').value },
        medicalNotes: document.getElementById('medicalNotes').value
      };

      try {
        const res = await authFetch(`${API}/api/seniors`, {
          method: 'POST',
          body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error('Failed');
        showToast('Senior added!');
        e.target.reset();
        loadSeniors();
        loadDashboard();
      } catch (err) {
        showToast('Failed to add senior', 'error');
      } finally {
        btn.disabled = false;
      }
    });

    let currentEditId = null;

    async function editSenior(id) {
      currentEditId = id;
      try {
        const res = await authFetch(`${API}/api/seniors/${id}`);
        const s = await res.json();
        document.getElementById('editSeniorId').value = id;
        document.getElementById('editName').value = s.name;
        document.getElementById('editPhone').value = s.phone;
        document.getElementById('editLocation').value = s.familyInfo?.location || '';
        document.getElementById('editInterests').value = (s.interests || []).join(', ');
        document.getElementById('editMedicalNotes').value = s.medicalNotes || '';
        loadMemories(id);
        document.getElementById('editSeniorModal').classList.add('show');
      } catch (e) {
        showToast('Failed to load senior', 'error');
      }
    }

    async function loadMemories(seniorId) {
      try {
        const res = await authFetch(`${API}/api/seniors/${seniorId}/memories`);
        const memories = await res.json();
        const container = document.getElementById('memoriesList');
        if (!memories.length) {
          container.innerHTML = '<p style="color: #888; font-size: 12px;">No memories yet</p>';
        } else {
          container.innerHTML = memories.map(m => `
            <div class="memory-chip">
              <span class="memory-type">${esc(m.type)}</span>
              ${esc(m.content)}
            </div>
          `).join('');
        }
      } catch (e) {
        console.error('Failed to load memories', e);
      }
    }

    async function addMemory() {
      const type = document.getElementById('memoryType').value;
      const content = document.getElementById('memoryContent').value.trim();
      if (!content) {
        showToast('Enter memory content', 'error');
        return;
      }
      try {
        await authFetch(`${API}/api/seniors/${currentEditId}/memories`, {
          method: 'POST',
          body: JSON.stringify({ type, content, importance: 70 })
        });
        document.getElementById('memoryContent').value = '';
        loadMemories(currentEditId);
        showToast('Memory added!');
      } catch (e) {
        showToast('Failed to add memory', 'error');
      }
    }

    document.getElementById('editSeniorForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('editSeniorId').value;
      const data = {
        name: document.getElementById('editName').value,
        phone: document.getElementById('editPhone').value,
        interests: document.getElementById('editInterests').value.split(',').map(i => i.trim()).filter(i => i),
        familyInfo: { location: document.getElementById('editLocation').value },
        medicalNotes: document.getElementById('editMedicalNotes').value
      };

      try {
        await authFetch(`${API}/api/seniors/${id}`, {
          method: 'PATCH',
          body: JSON.stringify(data)
        });
        showToast('Senior updated!');
        closeModal('editSeniorModal');
        loadSeniors();
      } catch (e) {
        showToast('Failed to update', 'error');
      }
    });

    async function deleteSenior(id) {
      if (!confirm('Delete this senior?')) return;
      try {
        await authFetch(`${API}/api/seniors/${id}`, {
          method: 'PATCH',
          body: JSON.stringify({ isActive: false })
        });
        showToast('Senior deleted');
        loadSeniors();
        loadDashboard();
      } catch (e) {
        showToast('Failed to delete', 'error');
      }
    }

    // Call senior (v3.0 - Claude + 4-layer observer)
    async function callSenior(phone, name) {
      if (!confirm(`Call ${name}?`)) return;
      try {
        const res = await authFetch(`${API}/api/call`, {
          method: 'POST',
          body: JSON.stringify({ phoneNumber: phone })
        });
        if (!res.ok) throw new Error('Failed');
        showToast(`Calling ${name}...`);
        setTimeout(loadDashboard, 2000);
      } catch (e) {
        showToast('Failed to call', 'error');
      }
    }

    // ============ CALLS ============
    async function loadCalls() {
      try {
        const res = await authFetch(`${API}/api/conversations`);
        const calls = await res.json();
        renderCalls(calls);
      } catch (e) {
        showToast('Failed to load calls', 'error');
      }
    }

    // Store calls data for transcript lookup
    let callsData = [];

    function renderCalls(calls) {
      callsData = calls; // Store for transcript lookup
      if (!calls.length) {
        document.getElementById('callsList').innerHTML = '<p class="empty-state">No calls yet</p>';
        return;
      }
      document.getElementById('callsList').innerHTML = calls.map((c, idx) => `
        <div class="list-item">
          <div>
            <h3>${esc(c.seniorName) || 'Unknown'}</h3>
            <p>${new Date(c.startedAt).toLocaleString()}</p>
            <p class="meta">Duration: ${formatDuration(c.durationSeconds)} &bull;
              <span class="status-badge ${c.status || ''}">${c.status || 'unknown'}</span>
            </p>
          </div>
          <div class="actions">
            ${c.transcript && c.transcript.length > 0 ? `<button class="small secondary" onclick="showTranscriptById(${idx})">Transcript</button>` : '<span class="meta">No transcript</span>'}
          </div>
        </div>
      `).join('');
    }

    function showTranscriptById(idx) {
      const call = callsData[idx];
      if (call) showTranscript(call);
    }

    function showTranscript(call) {
      document.getElementById('transcriptTitle').textContent =
        `Call with ${call.seniorName || 'Unknown'} - ${new Date(call.startedAt).toLocaleDateString()}`;

      const transcript = call.transcript || [];
      if (!transcript.length) {
        document.getElementById('transcriptContent').innerHTML = '<p class="empty-state">No transcript available</p>';
      } else {
        document.getElementById('transcriptContent').innerHTML = transcript.map(t => `
          <div class="transcript-message ${t.role === 'assistant' ? 'donna' : 'user'}">
            <div class="speaker">${t.role === 'assistant' ? 'Donna' : 'User'}</div>
            <div>${esc(t.content)}</div>
          </div>
        `).join('');
      }
      document.getElementById('transcriptModal').classList.add('show');
    }

    // ============ REMINDERS ============
    async function loadReminders() {
      try {
        const res = await authFetch(`${API}/api/reminders`);
        const reminders = await res.json();
        renderReminders(reminders);
      } catch (e) {
        showToast('Failed to load reminders', 'error');
      }
    }

    function renderReminders(reminders) {
      if (!reminders.length) {
        document.getElementById('remindersList').innerHTML = '<p class="empty-state">No reminders yet</p>';
        return;
      }
      document.getElementById('remindersList').innerHTML = reminders.map(r => {
        const schedule = r.isRecurring
          ? (r.cronExpression === '0 * * * *' ? 'Daily' : r.cronExpression || 'Recurring')
          : 'One-time';
        const time = r.scheduledTime ? new Date(r.scheduledTime).toLocaleString() : '-';
        return `
          <div class="list-item">
            <div>
              <h3>${r.type === 'medication' ? 'ðŸ’Š' : r.type === 'appointment' ? 'ðŸ“…' : 'ðŸ“Œ'} ${esc(r.title)}</h3>
              <p>${esc(r.seniorName)}</p>
              <p class="meta">${schedule} &bull; ${time}</p>
              ${r.lastDeliveredAt ? `<p class="meta">Last: ${formatDate(r.lastDeliveredAt)}</p>` : ''}
            </div>
            <div class="actions">
              <button class="small danger" onclick="deleteReminder('${r.id}')">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }

    document.getElementById('addReminderForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true;

      const recurring = document.querySelector('input[name="recurring"]:checked').value;
      const date = document.getElementById('reminderDate').value;
      const time = document.getElementById('reminderTime').value;

      let scheduledTime = null;
      let cronExpression = null;
      let isRecurring = false;

      if (recurring === 'daily') {
        isRecurring = true;
        cronExpression = '0 * * * *'; // Simplified - scheduler handles time matching
        // Set scheduledTime to today at the specified time for first trigger
        const today = new Date();
        const [h, m] = time.split(':');
        today.setHours(parseInt(h), parseInt(m), 0, 0);
        scheduledTime = today.toISOString();
      } else if (recurring === 'weekly') {
        isRecurring = true;
        cronExpression = 'weekly';
        const today = new Date();
        const [h, m] = time.split(':');
        today.setHours(parseInt(h), parseInt(m), 0, 0);
        scheduledTime = today.toISOString();
      } else {
        // One-time
        if (date && time) {
          scheduledTime = new Date(`${date}T${time}`).toISOString();
        }
      }

      const data = {
        seniorId: document.getElementById('reminderSenior').value,
        type: document.getElementById('reminderType').value,
        title: document.getElementById('reminderTitle').value,
        description: document.getElementById('reminderDescription').value,
        scheduledTime,
        isRecurring,
        cronExpression
      };

      try {
        const res = await authFetch(`${API}/api/reminders`, {
          method: 'POST',
          body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error('Failed');
        showToast('Reminder added!');
        e.target.reset();
        loadReminders();
        loadDashboard();
      } catch (err) {
        showToast('Failed to add reminder', 'error');
      } finally {
        btn.disabled = false;
      }
    });

    async function deleteReminder(id) {
      if (!confirm('Delete this reminder?')) return;
      try {
        await authFetch(`${API}/api/reminders/${id}`, { method: 'DELETE' });
        showToast('Reminder deleted');
        loadReminders();
        loadDashboard();
      } catch (e) {
        showToast('Failed to delete', 'error');
      }
    }

    // Close modals on overlay click
    document.querySelectorAll('.modal-overlay').forEach(m => {
      m.addEventListener('click', (e) => {
        if (e.target === m) m.classList.remove('show');
      });
    });

    function loadAll() {
      loadDashboard();
      loadSeniors();
      loadCalls();
      loadReminders();
    }

    // Initial auth check (replaces direct loadX calls)
    checkAuth();

    // Refresh dashboard every 30 seconds (only if logged in)
    setInterval(() => { if (authToken) loadDashboard(); }, 30000);
  </script>
</body>
</html>
